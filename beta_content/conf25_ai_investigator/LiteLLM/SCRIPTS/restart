#!/bin/bash

# LiteLLM Restart Script
# Restarts all project containers

set -e

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
PARENT_DIR="$(dirname "$SCRIPT_DIR")"

# Load environment variables from .env file
if [ -f "${PARENT_DIR}/.env" ]; then
    set -a
    source "${PARENT_DIR}/.env"
    set +a
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
WHITE='\033[0;37m'
NC='\033[0m' # No Color

# Clear screen at start
clear

echo -e "${WHITE}=== Restarting Services ===${NC}"

# Check if .env exists
if [ ! -f ".env" ]; then
    echo -e "${YELLOW}⚠️  No .env file found. Run './setup' first to configure services.${NC}"
    exit 1
fi

# Function to restart a specific service
restart_service() {
    local service=$1
    local compose_file=$2
    
    echo -e "\n${WHITE}Restarting $service services...${NC}"
    sudo docker compose -f $compose_file restart
    echo -e "${GREEN}✓ $service services restarted${NC}"
}

# Restart LiteLLM services
restart_service "LiteLLM" "docker-compose-litellm.yml"

echo -e "${GREEN}✓ All requested services restarted${NC}"
echo "Waiting for services to initialize..."
sleep 5

# Show status
echo ""
echo -e "${WHITE}=== Service Status ===${NC}"
echo -e "\n${WHITE}LiteLLM Services:${NC}"
sudo docker compose -f docker-compose-litellm.yml ps

# Show service endpoints
echo ""
echo -e "${WHITE}Service Endpoints:${NC}"
echo -e "${YELLOW}• LiteLLM Proxy: http://localhost:${LITELLM_PORT:-7010}${NC}"
echo -e "${YELLOW}• Raw Logger Proxy: http://localhost:${RAW_LOGGING_PORT:-7011}${NC}"
echo "• PostgreSQL (LiteLLM): localhost:${LITELLM_DB_PORT:-5435}"
